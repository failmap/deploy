# docker-compose configuration to build a complete local installation of the failmap platform.

version: "3"
services:
  # message broker to distribute tasks
  broker:
    image: rabbitmq

  # stateful storage
  database:
    image: mysql
    environment:
      MYSQL_ROOT_PASSWORD: secret

  # scan task executors, idempotent tasks that perform a scan with provided input and generate a result
  worker-1:
    build:
      context: source/admin
      dockerfile: ${PWD}/Dockerfile.worker
    depends_on:
      - broker
    environment:
      QUEUES: scan
  worker-2:
    build:
      context: source/admin
      dockerfile: ${PWD}/Dockerfile.worker
    links:
      - broker
    environment:
      BROKER_URL: amqp://guest:guest@broker
      QUEUES: scan

  # administrative task executer, these tasks require DB access, for example result parser, aggregators.
  adminworker-1:
    build:
      context: source/admin
      dockerfile: ${PWD}/Dockerfile.worker
    links:
      - broker
      - database
    environment:
      BROKER_URL: amqp://guest:guest@broker
      QUEUES: administrative
      DB_HOST: database
      DB_USER: root
      DB_PASSWORD: secret

  # administrative web interface and task initiator
  admin-website:
    build:
      context: source/admin
      dockerfile: ${PWD}/Dockerfile.admin
    links:
      - broker
      - database
    environment:
      BROKER_URL: amqp://guest:guest@broker
      DB_HOST: database
      DB_USER: root
      DB_PASSWORD: secret
    ports:
      - 8080:8080

  # visitor facing, high performance frontend
  website:
    build:
      context: source/admin
      dockerfile: ${PWD}/Dockerfile.website
    links:
      - database
    environment:
      DB_HOST: database
      DB_USER: readonly
      DB_PASSWORD: secret
    ports:
      - 8081:8081
